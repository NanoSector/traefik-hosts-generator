package file_writer

import (
	"errors"
	"io/ioutil"
	"os"
	"strings"
)

const (
	EntriesHeader = "######## AUTOGENERATED BY TRAEFIK_HOSTS_GENERATOR ################"
	EntriesFooter = "######## AUTOGENERATED BY TRAEFIK_HOSTS_GENERATOR END ############"
)

func WriteToHosts(newHosts, hostsLocation, lineEndings, postfix string) error {
	currentContent, err := readHostsContent(hostsLocation)
	if err != nil {
		return err
	}

	entriesHeader := EntriesHeader + " " + postfix
	entriesFooter := EntriesFooter + " " + postfix

	headerPresent := isHeaderPresent(currentContent, entriesHeader)
	footerPresent := isFooterPresent(currentContent, entriesFooter)



	if headerPresent && footerPresent {
		headerStart := strings.Index(currentContent, entriesHeader )
		footerStart := strings.Index(currentContent, entriesFooter)

		oldContent := currentContent[headerStart+len(entriesHeader ) : footerStart]
		newContent := strings.Replace(currentContent, oldContent, lineEndings+newHosts, -1)

		err = ioutil.WriteFile(hostsLocation, []byte(newContent), 0)
		if err != nil {
			return err
		}

		return nil
	}

	if !headerPresent && !footerPresent {
		f, err := os.OpenFile(hostsLocation, os.O_APPEND|os.O_CREATE|os.O_WRONLY, 0600)
		if err != nil {
			return err
		}

		defer f.Close()
		newHosts = entriesHeader  + lineEndings + newHosts + lineEndings + entriesFooter

		if _, err = f.WriteString(newHosts); err != nil {
			return err
		}
		return nil
	}

	return errors.New("hosts content malformed, traefik section is partially present")
}

func readHostsContent(hostsLocation string) (string, error) {
	content, err := ioutil.ReadFile(hostsLocation)
	if err != nil {
		return "", nil
	}

	return string(content), nil
}

func isHeaderPresent(content, header string) bool {
	return strings.Contains(content, header)
}

func isFooterPresent(content, header string) bool {
	return strings.Contains(content, header)
}
